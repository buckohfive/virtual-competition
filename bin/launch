#!/usr/bin/env bash

set -eu

which cgcef_verify >/dev/null || { echo "I need CGC scripts, run me in their VM!"; exit 1; }

MYDIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
CHALLENGES="/vagrant/shared/cgc-challenges"
WEBROOT="/vagrant/shared/webroot"
LOGROOT="/vagrant/logs"
ROUNDLEN=${ROUNDLEN-300}
ROUNDS=${ROUNDS-100}
POLLS=${POLLS-10}
CS_LIMIT=${CS_LIMIT-30}
CS_ROUNDS_DURATION=${CS_ROUNDS_DURATION-10}

if [ ! -d $LOGROOT ]; then
    mkdir $LOGROOT
fi

echo $(date): $0 $@ >> $LOGROOT/launch.log

function running {
    if pgrep $1 > /dev/null && [ -e $LOGROOT/${1}.pid ] ; then
        return 0
    else
        return 1
    fi
}

function status {
    if running ti-server; then
        echo "ti-server is running with PID `cat $LOGROOT/ti-server.pid`"
    else
        echo "ti-server STOPPED"
    fi
    if running ti-rotate; then
        echo "ti-rotate is running with PID `cat $LOGROOT/ti-rotate.pid`"
    else
        echo "ti-rotate STOPPED"
    fi
}

function start {
    if [ -z "$1" ] || [ "$1" = ti-rotate ]; then
        if running ti-rotate; then
            echo "ti-rotate already running!"
            exit 1
        fi

        rm -rf "$WEBROOT"
        mkdir "$WEBROOT"
        # Note: run only one of these! This is the real round-by-round simulation
        nohup "$MYDIR/ti-rotate" --cbdir "$CHALLENGES" --webroot "$WEBROOT" \
                           --roundlen "$ROUNDLEN" --team 6 --rounds "$ROUNDS" \
                           --polls "$POLLS" \
                           --cs-limit "$CS_LIMIT" --cs-rounds-duration "$CS_ROUNDS_DURATION" \
                           --log $LOGROOT/ti-rotate.log \
                           --debug >$LOGROOT/ti-rotate.stdout 2>$LOGROOT/ti-rotate.stderr &
        echo $! > $LOGROOT/ti-rotate.pid
        echo "ti-rotate STARTED"
    fi

    if [ -z "$1" ] || [ "$1" = ti-server ]; then
        if running ti-server; then
            echo "ti-server already running!"
            exit 1
        fi

        nohup "$MYDIR/ti-server" --cbdir "$CHALLENGES" --webroot "$WEBROOT" \
                           --port 8888 \
                           --username "team-6" --password 9fb864f629eb4502edd795e5b7d5c3a0bac0aa8f56c183e3f795c523c0d4f82f \
                           --debug >$LOGROOT/ti-server.stdout 2>$LOGROOT/ti-server.stderr &
        echo $! > $LOGROOT/ti-server.pid
        echo "ti-server STARTED"
        sleep 1                 # nohup takes time to start
    fi

    echo "Launched! For logs and info, see $LOGROOT/ti-{rotate,server}.*"
}

function stop {
    if [ -z "$1" ] || [ "$1" = ti-server ]; then
        if running ti-server; then
            kill `cat $LOGROOT/ti-server.pid`
            rm $LOGROOT/ti-server.pid
            echo "ti-server STOPPED"
        fi
    fi
    if [ -z "$1" ] || [ "$1" = ti-rotate ]; then
        if running ti-rotate; then
            kill `cat $LOGROOT/ti-rotate.pid`
            rm $LOGROOT/ti-rotate.pid
            echo "ti-rotate STOPPED"
        fi
    fi
}

function reset {
    if ! which realpath >/dev/null; then
        # PLEASE
        REALROOT=/vagrant
    else
        REALROOT=$(dirname $(dirname $(realpath $0)))
    fi

    mv /vagrant/shared/cgc-challenges/* $REALROOT/shared/cgc-challenges-unfielded 2>/dev/null
    mv /vagrant/shared/cgc-challenges-spent/* $REALROOT/shared/cgc-challenges-unfielded 2>/dev/null
}

function logs {
    echo $LOGROOT/$1
    if [ -f $LOGROOT/$1 ]; then
        cat $LOGROOT/$1
    else
        echo 'Usage: logs [logfile]'
        echo 'Available log files:'
        ls $LOGROOT | cat
    fi
}

case "${1-help}" in
    start)
        start "${2-}"
        ;;
    stop)
        stop "${2-}"
        ;;
    restart)
        stop "${2-}"
        start "${2-}"
        ;;
    status)
        status
        ;;
    reset)
        reset
        ;;
    logs)
        logs "${2-}"
        ;;
    *)
        echo "Usage: ${BASH_SOURCE[0]} {start|stop|restart|status|reset|logs}"
        ;;
esac
